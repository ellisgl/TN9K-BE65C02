# 6502 I2C LCD Driver

Three-file modular driver for HD44780 16x2 LCD displays via PCF8574 I2C expander.

## Files

- **src/inc/I2C.s** - Low-level bit-banged I2C driver using 6522 VIA
- **src/inc/1602-I2C.s** - HD44780 LCD driver (4-bit mode via I2C)
- **src/1602-I2C-Demo.s** - Example program demonstrating usage

## Hardware Configuration

- **6522 VIA** at base address `$6000`
- **PB0** - I2C SDA (data)
- **PB1** - I2C SCL (clock)
- **PCF8574** I2C expander at address `$27` (default)
- **LCD** - HD44780-compatible 16x2 character display

### PCF8574 to LCD Wiring

```
PCF8574 Pin -> LCD Pin
P7 -> D7
P6 -> D6
P5 -> D5
P4 -> D4
P3 -> Backlight (via transistor)
P2 -> EN (Enable)
P1 -> RW (Read/Write)
P0 -> RS (Register Select)
```

## Assembly Instructions

### Using VASM (recommended)

```bash
tools/vasm6502_oldstyle -Fbin -dotdir -o rtl/build/eater.bin src/1602-I2C-demo.s src/inc/I2C.s src/inc/1602-I2C.s
```

### Alternative assemblers

Adjust syntax as needed. Key points:
- Zero page section uses `.dsect`/`.dend`
- Code sections use `.org`
- Exports use `.global`
- Imports use `.extern`

## API Reference

### I2C Driver (src/inc/I2C.s)

#### I2C_Init
Initialize I2C interface (sets up VIA ports)
```
JSR I2C_Init
```

#### I2C_SetAddress
Set 7-bit I2C device address
```
LDA #$27        ; I2C address
JSR I2C_SetAddress
```

#### I2C_WriteByte
Write a byte to the I2C device
```
LDA #$08        ; Data byte
JSR I2C_WriteByte
```

#### I2C_Start
Generate I2C start condition (low-level)
```
JSR I2C_Start
```

#### I2C_Stop
Generate I2C stop condition (low-level)
```
JSR I2C_Stop
```

### LCD Driver (src/inc/1602-I2C.s)

#### LCD_Init
Initialize LCD display
```
LDA #$27        ; I2C address of PCF8574
JSR LCD_Init
```

#### LCD_Clear
Clear display and return cursor to home
```
JSR LCD_Clear
```

#### LCD_Home
Return cursor to home position (0,0)
```
JSR LCD_Home
```

#### LCD_SetCursor
Set cursor position
```
LDA #5          ; Column (0-15)
LDX #1          ; Row (0-1)
JSR LCD_SetCursor
```

#### LCD_WriteChar
Write a single character
```
LDA #'A'        ; ASCII character
JSR LCD_WriteChar
```

#### LCD_WriteString
Write null-terminated string
```
LDA #<my_string
STA LCD_StrPtr
LDA #>my_string
STA LCD_StrPtr+1
JSR LCD_WriteString

my_string:
    .byte "Hello!", 0
```

## Example Usage

```assembly
; Initialize
JSR I2C_Init
LDA #$27
JSR LCD_Init

; Write to line 1
LDA #<msg1
STA LCD_StrPtr
LDA #>msg1
STA LCD_StrPtr+1
JSR LCD_WriteString

; Write to line 2
LDA #0          ; Column 0
LDX #1          ; Row 1
JSR LCD_SetCursor

LDA #<msg2
STA LCD_StrPtr
LDA #>msg2
STA LCD_StrPtr+1
JSR LCD_WriteString

msg1: .byte "Hello World!", 0
msg2: .byte "Line 2", 0
```

## Timing Notes

- I2C clock speed: ~50-100kHz (depends on CPU speed)
- No explicit delays after LCD commands (works at 1MHz CPU)
- If using faster CPU, may need to add delays after:
  - `LCD_Clear` (needs 1.52ms)
  - `LCD_Home` (needs 1.52ms)

## Troubleshooting

### No display / blank screen
1. Check contrast potentiometer (blue trimpot on I2C module)
2. Verify I2C address (scan with logic analyzer)
3. Check power to LCD backlight

### Garbled characters
1. Wrong I2C address
2. Bad PCF8574 to LCD wiring
3. Contrast too high/low

### I2C not working
1. Check SDA/SCL connections to VIA PB0/PB1
2. Verify VIA base address matches hardware
3. Check pull-up resistors on SDA/SCL lines

## License

Public domain. Use freely.
